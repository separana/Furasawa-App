<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<title>Furusawa JP Collection</title>
<style>
:root{
  /* PokÃ©mon-stijl dark */
  --bg:#0b1020; --card:#11162b; --muted:#aab3cf; --text:#f5f7ff; --line:#1e2747;
  --accent:#e60012; /* PokÃ© red */
  --accent2:#ffcc00; /* Pikachu yellow */
  --pill:#0e1530;
}
:root.light{
  --bg:#f7f8fb; --card:#ffffff; --muted:#465066; --text:#0b1020; --line:#e0e5f4;
  --accent:#d90416; --accent2:#f2b800; --pill:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
/* Sticky search only */
.topbar{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);
  background:color-mix(in hsl, var(--bg), transparent 40%);border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:0 auto;padding:10px 16px}
.title{display:flex;align-items:center;gap:10px}
.title h1{margin:0;font-size:18px}
.searchrow{display:flex;gap:8px;align-items:center;margin-top:8px}
.searchrow input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--text);font-size:14px}
.themebtn{width:42px;height:42px;border:1px solid var(--line);border-radius:12px;background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center}
.themebtn span{font-size:18px}
/* Non-sticky filter+stats (below header) */
.controls{padding:8px 16px;border-bottom:1px solid var(--line)}
.controls .row{display:flex;gap:8px;flex-wrap:wrap}
.controls select{padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--text)}
.stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:7px 10px;border-radius:999px;background:var(--pill);border:1px solid var(--line);color:var(--muted);font-size:12px}
/* Set subtotals */
.setstats{display:flex;gap:10px;flex-wrap:wrap;margin:12px 16px}
.setbox{padding:8px 10px;border-radius:12px;background:var(--card);border:1px solid var(--line);font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
.pokebadge{display:inline-flex;align-items:center;gap:6px}
.pokeball{width:16px;height:16px;border-radius:50%;background:
  radial-gradient(circle at 50% 50%, #fff 0 30%, transparent 31%),
  linear-gradient(#fff 0 50%, #000 50% 54%, #e60012 54% 100%);
  border:1px solid #0003}
/* Grid (3 kolommen) */
main{padding:16px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.imgbox{aspect-ratio:3/4;background:color-mix(in hsl, var(--bg), white 6%)}
.imgbox img{width:100%;height:100%;object-fit:contain;display:block}
.meta{padding:10px 12px}
.title2{font-weight:700;font-size:14px}
.sub{color:var(--muted);font-size:12px;margin-top:2px}
.row{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:6px}
.price{font-size:13px}
/* Floating Gallery button */
.galleryBtn{position:fixed;right:16px;bottom:16px;z-index:30;background:var(--accent);color:#fff;
  width:56px;height:56px;border-radius:50%;border:2px solid #0008;box-shadow:0 6px 16px #0006;cursor:pointer;display:flex;align-items:center;justify-content:center}
.galleryBtn::before{content:'';width:24px;height:24px;border-radius:50%;
  background:
   radial-gradient(circle at 50% 50%, #fff 0 30%, transparent 31%),
   linear-gradient(#fff 0 50%, #000 50% 54%, #fff 54% 100%);
  border:2px solid #0008}
/* Modal Gallery */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;padding:24px;z-index:40}
.modal.open{display:flex}
.modal-inner{position:relative;max-width:min(96vw,1100px);max-height:92vh;background:transparent;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;align-items:center}
.modal-img{width:min(90vw,900px);max-height:82vh;object-fit:contain;display:block}
.modal-nav{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;pointer-events:none}
.navbtn{pointer-events:auto;background:rgba(0,0,0,.4);border:1px solid #fff3;color:#fff;border-radius:50%;width:46px;height:46px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
.fullbtn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.35);border:1px solid #fff3;color:#fff;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.fullbtn::before{content:'';width:20px;height:20px;border-radius:50%;
  background:
   radial-gradient(circle at 50% 50%, #fff 0 30%, transparent 31%),
   linear-gradient(#fff 0 50%, #000 50% 54%, #e60012 54% 100%);
  border:1px solid #0008}
/* Loader (PokÃ©ball) */
.loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:50;transition:opacity .3s ease}
.loader.hidden{opacity:0;pointer-events:none}
.spin{width:56px;height:56px;border-radius:50%;
  background:
    radial-gradient(circle at 50% 50%, #fff 0 30%, transparent 31%),
    linear-gradient(#fff 0 50%, #000 50% 54%, #e60012 54% 100%);
  border:2px solid #0006; animation:rot 1s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="appLoader" class="loader"><div class="spin"></div></div>

<div class="topbar">
  <div class="wrap">
    <div class="title">
      <h1>Furusawa JP Collection</h1>
      <button id="themeBtn" class="themebtn" title="Dark/Light"><span>ðŸŒ“</span></button>
    </div>
    <div class="searchrow">
      <input id="search" placeholder="Zoek (naam / set / nummer)â€¦" />
    </div>
  </div>
</div>

<div class="controls">
  <div class="wrap">
    <div class="row">
      <select id="setFilter"><option value="">Alle sets</option></select>
      <select id="rarityFilter"><option value="">Alle rariteiten</option></select>
      <select id="sortSel">
        <option value="">Sorteer: origineel</option>
        <option value="nm">Sorteer op NM waarde</option>
        <option value="psa">Sorteer op PSA10 waarde</option>
        <option value="year">Sorteer op jaar</option>
      </select>
    </div>
    <div id="stats" class="stats" style="margin-top:10px"><div class="pill">Ladenâ€¦</div></div>
  </div>
</div>

<div id="setstats" class="setstats"></div>

<main>
  <div class="wrap">
    <div class="grid" id="grid"></div>
  </div>
</main>

<button id="galleryBtn" class="galleryBtn" title="Galerij"></button>

<!-- Gallery Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-inner">
    <button id="fullBtn" class="fullbtn" title="Fullscreen"></button>
    <img id="mImg" class="modal-img" alt="Card image">
    <div class="modal-nav">
      <button id="prevBtn" class="navbtn" title="Vorige">â—€</button>
      <button id="nextBtn" class="navbtn" title="Volgende">â–¶</button>
    </div>
  </div>
</div>

<script>
let DATA = [];
const PATH = './data/furusawa_jp.json';
let currentIndex = 0;

function money(v){ v = Number(v||0); return 'â‚¬' + v.toFixed(2); }

// Theme toggle with persistence
function applyTheme(t){ document.documentElement.classList.toggle('light', t==='light'); localStorage.setItem('fj_theme', t); }
(function(){ const t = localStorage.getItem('fj_theme') || 'dark'; applyTheme(t); })();
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const t = document.documentElement.classList.contains('light') ? 'light' : 'dark';
  applyTheme(t==='light' ? 'dark' : 'light');
});

// Loader control
const appLoader = document.getElementById('appLoader');
function hideLoader(){ appLoader.classList.add('hidden'); setTimeout(()=>appLoader.remove(),350); }

async function load(){
  try{
    const res = await fetch(PATH + '?ts=' + Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    DATA = await res.json();
  }catch(e){
    alert('Kon ./data/furusawa_jp.json niet laden ('+e.message+'). Zet het bestand in /data op je repo-root.');
    hideLoader();
    return;
  }
  render();
  hideLoader();
}

function render(){
  const q = document.getElementById('search').value.toLowerCase();
  const setF = document.getElementById('setFilter').value;
  const rarF = document.getElementById('rarityFilter').value;
  const sort = document.getElementById('sortSel').value;

  // Populate filter options
  const sets = Array.from(new Set(DATA.map(c=>c.set_code).filter(Boolean))).sort();
  const rars = Array.from(new Set(DATA.map(c=>c.rarity).filter(Boolean))).sort();
  document.getElementById('setFilter').innerHTML = '<option value=\"\">Alle sets</option>' + sets.map(s=>`<option ${s===setF?'selected':''}>${s}</option>`).join('');
  document.getElementById('rarityFilter').innerHTML = '<option value=\"\">Alle rariteiten</option>' + rars.map(r=>`<option ${r===rarF?'selected':''}>${r}</option>`).join('');

  let arr = DATA.filter(c=>{
    const hay = [c.en_name,c.jp_name,c.set_code,c.card_no,(c.set_name||'')].join(' ').toLowerCase();
    const passQ = q ? hay.includes(q) : true;
    const passS = setF ? c.set_code === setF : true;
    const passR = rarF ? c.rarity === rarF : true;
    return passQ && passS && passR;
  });

  if (sort==='nm') arr = arr.slice().sort((a,b)=>Number(b.price_nm_eur||0)-Number(a.price_nm_eur||0));
  else if (sort==='psa') arr = arr.slice().sort((a,b)=>Number(b.price_psa10_eur||0)-Number(a.price_psa10_eur||0));
  else if (sort==='year') arr = arr.slice().sort((a,b)=>String(a.year).localeCompare(String(b.year)));

  // Stats
  const owned = arr.filter(c=>c.owned).length;
  const total = arr.length;
  const nm = arr.reduce((s,c)=>s+Number(c.price_nm_eur||0),0);
  const psa = arr.reduce((s,c)=>s+Number(c.price_psa10_eur||0),0);
  const paid = arr.reduce((s,c)=>s+Number(c.paid_eur||0),0);
  document.getElementById('stats').innerHTML = `
    <div class="pill">Kaarten (filter): <strong>${owned}/${total}</strong></div>
    <div class="pill">Totaal NM: <strong>${money(nm)}</strong></div>
    <div class="pill">Totaal PSA10: <strong>${money(psa)}</strong></div>
    <div class="pill">P/L (t.o.v. Betaald ${money(paid)}): <strong>${money(nm - paid)}</strong></div>
  `;

  // Per-set subtotals
  const setStats = {};
  arr.forEach(c=>{
    const k = c.set_code || 'â€”';
    if(!setStats[k]) setStats[k] = {nm:0, psa:0, paid:0, count:0};
    setStats[k].nm += Number(c.price_nm_eur||0);
    setStats[k].psa += Number(c.price_psa10_eur||0);
    setStats[k].paid += Number(c.paid_eur||0);
    setStats[k].count++;
  });
  const setstatsDiv = document.getElementById('setstats');
  setstatsDiv.innerHTML = Object.entries(setStats).map(([k,v])=>`
    <div class="setbox">
      <span class="pokebadge"><span class="pokeball"></span> <strong style="color:var(--accent2)">${k}</strong></span>
      â€” ${v.count} kaarten Â· NM ${money(v.nm)} Â· PSA10 ${money(v.psa)} Â· P/L ${money(v.nm - v.paid)}
    </div>
  `).join('');

  // Grid
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  arr.forEach((c, idx)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="imgbox"><img src="${c.thumb||c.image||''}" alt=""></div>
      <div class="meta">
        <div class="title2">${c.en_name||''}</div>
        <div class="sub">${(c.set_name||'')}${c.set_name?' â€¢ ':''}${c.set_code||''} â€¢ ${c.card_no||''} â€¢ ${c.rarity||''} â€¢ ${c.year||''}</div>
        <div class="row"><div class="price">NM: ${money(c.price_nm_eur)} â€¢ PSA10: ${money(c.price_psa10_eur)}</div>
          <button class="btn" data-open="${idx}">Open</button>
        </div>
      </div>`;
    grid.appendChild(el);
  });

  grid.querySelectorAll('button[data-open]').forEach((b)=>{
    b.addEventListener('click', ()=> openGallery(arr, Number(b.dataset.open)));
  });

  // "Galerij" floating button -> open from first of current filtered set
  document.getElementById('galleryBtn').onclick = ()=> openGallery(arr, 0);
}

function openGallery(list, startIndex){
  const modal = document.getElementById('modal');
  const mImg = document.getElementById('mImg');
  let idx = startIndex;
  if (!list.length) return;

  function show(i){
    idx = (i + list.length) % list.length;
    currentIndex = idx;
    const url = list[idx].image || list[idx].thumb || '';
    // show loader overlay quickly
    mImg.style.opacity = '0';
    // preload
    const tmp = new Image();
    tmp.onload = ()=>{ mImg.src = url; mImg.style.opacity='1'; };
    tmp.src = url;
  }
  function prev(){ show(idx-1); }
  function next(){ show(idx+1); }

  document.getElementById('prevBtn').onclick = prev;
  document.getElementById('nextBtn').onclick = next;

  // Keyboard arrows
  const keyHandler = (e)=>{
    if (!modal.classList.contains('open')) return;
    if (e.key === 'ArrowLeft') prev();
    else if (e.key === 'ArrowRight') next();
    else if (e.key === 'Escape') modal.classList.remove('open');
  };
  document.addEventListener('keydown', keyHandler, { once:false });

  // Swipe
  let sx=0, dx=0;
  modal.onpointerdown = (e)=>{ sx = e.clientX; };
  modal.onpointerup = (e)=>{ dx = e.clientX - sx; if (dx>50) prev(); if (dx<-50) next(); };

  // Fullscreen toggle
  const fullBtn = document.getElementById('fullBtn');
  fullBtn.onclick = ()=>{
    if (!document.fullscreenElement) {
      modal.requestFullscreen().catch(()=>{});
    } else {
      document.exitFullscreen().catch(()=>{});
    }
  };

  modal.classList.add('open');
  show(idx);

  // close when clicking backdrop (not on image/buttons)
  modal.onclick = (e)=>{ if (e.target.id==='modal') modal.classList.remove('open'); };
}

document.getElementById('search').addEventListener('input', render);
document.getElementById('setFilter').addEventListener('change', render);
document.getElementById('rarityFilter').addEventListener('change', render);
document.getElementById('sortSel').addEventListener('change', render);

load();
</script>
</body>
</html>
